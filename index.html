<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Pastel Pro - Mastery Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;500&display=swap');

        :root { 
            --primary: #ff85a1; 
            --primary-dark: #f06292;
            --secondary: #5d4037; 
            --bg: #fff5f8; 
            --card-bg: #ffffff;
            --shadow: rgba(255, 133, 161, 0.15);
        }
        
        body { font-family: 'Kanit', sans-serif; background-color: var(--bg); padding: 20px; text-align: center; margin: 0; color: var(--secondary); }
        
        .header-section { 
            background: white; padding: 30px; border-radius: 40px; 
            box-shadow: 0 15px 30px var(--shadow); 
            display: inline-block; width: 95%; max-width: 800px; margin-bottom: 30px;
            border: 3px solid #ffdae3;
        }

        .input-group { display: flex; justify-content: center; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
        .settings-group { margin-top: 20px; padding: 12px 25px; background: #fff0f3; border-radius: 25px; display: inline-flex; align-items: center; gap: 15px; }
        
        input[type=text] { padding: 12px 25px; width: 250px; border: 2px solid #ffdae3; border-radius: 35px; font-size: 16px; outline: none; transition: 0.3s; }
        input[type=text]:focus { border-color: var(--primary); background: #fff; }
        
        button { padding: 10px 22px; cursor: pointer; border: none; border-radius: 35px; font-weight: bold; transition: 0.3s; font-family: 'Kanit', sans-serif; }
        button:hover { transform: translateY(-2px); filter: brightness(1.05); }
        button:active { transform: scale(0.95); }

        .btn-create { background-color: var(--primary); color: white; }
        .btn-hard-all { background-color: #ba68c8; color: white; }
        .btn-reset { background-color: #eceff1; color: #78909c; }

        #card-container { 
            display: flex; overflow-x: auto; gap: 25px; padding: 20px 40px; 
            scroll-behavior: smooth; min-height: 620px;
        }
        #card-container::-webkit-scrollbar { height: 10px; }
        #card-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        .card { 
            background: var(--card-bg); padding: 30px; border-radius: 45px; 
            box-shadow: 0 20px 40px var(--shadow); 
            min-width: 320px; flex-shrink: 0; border: 2px solid #fff0f3;
            transition: 0.4s; position: relative;
        }

        .hide-content { opacity: 0; pointer-events: none; transition: 0.4s; }
        
        .pinyin-text { font-size: 36px; color: var(--primary-dark); font-weight: bold; margin-bottom: 10px; }
        .writer-container { 
            width: 210px; height: 210px; margin: 0 auto 20px; 
            border: 4px solid #fff0f3; background: #fff; border-radius: 30px; cursor: crosshair; 
        }
        
        .controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 15px;
        }
        
        .btn-small { padding: 12px; font-size: 13px; border-radius: 20px; }
        .btn-anim { background: #ffebee; color: #d81b60; }
        .btn-speak { background: #f3e5f5; color: #7b1fa2; }
        .btn-test { background: #fce4ec; color: #ad1457; border: 1.5px solid #f8bbd0; }
        .btn-blank-single { background: var(--primary); color: white; }
        
        .status-msg { font-size: 15px; font-weight: bold; margin-top: 15px; min-height: 22px; color: #9e9e9e; }
        .mistake-tag { color: #f44336; font-size: 13px; margin-top: 5px; font-weight: bold; }
        .success-text { color: var(--primary-dark) !important; }
    </style>
</head>
<body>

    <div class="header-section">
        <h1 style="margin:0 0 10px 0; color: var(--primary-dark); font-weight: 500;">üå∏ Chinese Pastel Pro</h1>
        <div class="input-group">
            <input type="text" id="chinese-input" placeholder="‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." value="Â≠∏Áøí">
            <button class="btn-create" onclick="generateCards()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î</button>
            <button class="btn-hard-all" onclick="startGlobalHardMode()">üî• ‡∏•‡∏∏‡∏¢‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î</button>
            <button class="btn-reset" onclick="resetAll()">‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≠</button>
        </div>
        <div class="settings-group">
            <span style="font-weight:bold; color: var(--primary-dark);">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô:</span>
            <input type="range" id="speed-slider" min="0.5" max="3" step="0.5" value="1" oninput="updateSpeedDisplay(this.value)">
            <span id="speed-val" style="font-weight:bold; color:var(--primary); width: 30px;">1x</span>
        </div>
    </div>

    <div id="card-container"></div>

    <script>
        let writerInstances = {};
        let mistakeCount = {};
        let currentCards = [];

        function updateSpeedDisplay(val) {
            document.getElementById('speed-val').innerText = val + 'x';
        }

        function playTone(freqs, type = 'sine', duration = 0.1) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                freqs.forEach((freq, index) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime + (index * 0.05));
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(audioCtx.currentTime + (index * 0.05));
                    osc.stop(audioCtx.currentTime + duration + (index * 0.05));
                });
            } catch(e) {}
        }

        function generateCards() {
            const input = document.getElementById('chinese-input').value.trim();
            const container = document.getElementById('card-container');
            if (!input) return;
            container.innerHTML = ''; 
            writerInstances = {}; 
            mistakeCount = {};
            currentCards = [];

            for (let char of input) {
                if (!/[\u4e00-\u9fa5]/.test(char)) continue; 

                const cardId = 'id-' + Math.random().toString(36).substr(2, 9);
                currentCards.push({ id: cardId, char: char });
                mistakeCount[cardId] = 0;
                
                const card = document.createElement('div');
                card.className = 'card';
                const charPinyin = pinyinPro.pinyin(char);

                card.innerHTML = `
                    <div id="pinyin-${cardId}" class="pinyin-text">${charPinyin}</div>
                    <div id="${cardId}" class="writer-container"></div>
                    <div id="msg-${cardId}" class="status-msg">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üå∏</div>
                    <div id="mistake-${cardId}" class="mistake-tag"></div>
                    
                    <div class="controls" id="ctrl-${cardId}">
                        <button class="btn-small btn-anim" onclick="animateChar('${cardId}', '${char}')">üå∏ ‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
                        <button class="btn-small btn-speak" onclick="speak('${char}')">üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
                        <button class="btn-small btn-test" onclick="startSingleQuiz('${cardId}', '${char}', 'normal')">‚úçÔ∏è ‡∏•‡∏≤‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô</button>
                        <button class="btn-small btn-blank-single" onclick="startSingleQuiz('${cardId}', '${char}', 'blank')">üìù ‡∏à‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
                    </div>
                `;
                container.appendChild(card);
                createWriter(cardId, char, { showOutline: true });
            }
        }

        function createWriter(elementId, char, options) {
            const speed = parseFloat(document.getElementById('speed-slider').value);
            document.getElementById(elementId).innerHTML = '';
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡πÑ‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
            writerInstances[elementId] = HanziWriter.create(elementId, char, {
                width: 210,
                height: 210,
                padding: 15,
                showOutline: options.showOutline,
                strokeColor: '#5d4037',
                radicalColor: '#ff4081',
                outlineColor: '#fff0f3',
                gridLines: { showValue: true, color: '#ffdae3', style: 'dash' },
                // ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ:
                strokeAnimationSpeed: speed, 
                delayBetweenStrokes: 200 / speed,
                strokeHighlightSpeed: 2 * speed
            });
        }

        function startSingleQuiz(elementId, char, mode) {
            const msgBox = document.getElementById(`msg-${elementId}`);
            const pinyin = document.getElementById(`pinyin-${elementId}`);
            const ctrl = document.getElementById(`ctrl-${elementId}`);
            const mistakeBox = document.getElementById(`mistake-${elementId}`);
            const speed = parseFloat(document.getElementById('speed-slider').value);

            mistakeCount[elementId] = 0;
            mistakeBox.innerText = "";
            msgBox.classList.remove('success-text');

            if (mode === 'blank') {
                pinyin.classList.add('hide-content');
                ctrl.classList.add('hide-content');
                msgBox.innerText = "‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏õ‡∏•‡πà‡∏≤... ‡∏•‡∏∏‡∏¢!";
                createWriter(elementId, char, { showOutline: false });
            } else {
                msgBox.innerText = "‡∏ù‡∏∂‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞...";
                createWriter(elementId, char, { showOutline: true });
            }
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î Quiz ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
            writerInstances[elementId].quiz({
                showHintAfterMisses: 3,
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á
                highlightColor: '#ff85a1',
                onMistake: () => {
                    mistakeCount[elementId]++;
                    playTone([180], 'sawtooth', 0.2);
                    msgBox.innerText = "‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚úåÔ∏è";
                },
                onCorrectStroke: () => {
                    playTone([900], 'sine', 0.1);
                    msgBox.innerText = "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!";
                },
                onComplete: function() {
                    playTone([523, 659, 783], 'sine', 0.4);
                    const total = mistakeCount[elementId];
                    msgBox.innerText = "üíñ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
                    msgBox.classList.add('success-text');
                    mistakeBox.innerText = total > 0 ? `‡∏ú‡∏¥‡∏î ${total} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á` : "‡πÄ‡∏û‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏Å‡∏ï‡πå! ‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î‡πÄ‡∏•‡∏¢";
                    
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#ff85a1', '#f06292'] });

                    pinyin.classList.remove('hide-content');
                    ctrl.classList.remove('hide-content');
                    writerInstances[elementId].showCharacter();
                    setTimeout(() => speak(char), 500);
                }
            });
        }

        function startGlobalHardMode() {
            if (currentCards.length === 0) return;
            currentCards.forEach(item => startSingleQuiz(item.id, item.char, 'blank'));
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN';
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        function animateChar(elementId, char) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á writer ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            createWriter(elementId, char, { showOutline: true });
            writerInstances[elementId].animateCharacter();
        }

        function resetAll() {
            document.getElementById('card-container').innerHTML = '';
            document.getElementById('chinese-input').value = '';
            writerInstances = {};
            mistakeCount = {};
            currentCards = [];
        }

        window.onload = generateCards;
    </script>
</body>
</html>